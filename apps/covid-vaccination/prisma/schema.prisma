// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
  DOCTOR
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  passwordHash String  @map("password_hash")
  role        UserRole @default(STAFF)
  firstName   String   @map("first_name")
  lastName    String   @map("last_name")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  doctor      Doctor?

  @@map("users")
  @@index([email])
}

model Clinic {
  id            Int      @id @default(autoincrement())
  name          String
  address       String
  city          String
  postalCode    String   @map("postal_code")
  phone         String?
  email         String?
  capacityPerDay Int     @map("capacity_per_day")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  doctors       Doctor[]
  appointments Appointment[]

  @@map("clinics")
  @@index([city])
}

model Doctor {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  clinicId      Int      @map("clinic_id")
  licenseNumber String   @unique @map("license_number")
  specialization String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic        Clinic   @relation(fields: [clinicId], references: [id])
  appointments Appointment[]
  vaccinations Vaccination[]

  @@map("doctors")
  @@index([clinicId])
  @@index([licenseNumber])
}

model Patient {
  id          String   @id @default(uuid())
  pesel       String   @unique
  firstName   String   @map("first_name")
  lastName    String   @map("last_name")
  dateOfBirth DateTime @map("date_of_birth")
  email       String?
  phone       String?
  address     String?
  city        String?
  postalCode  String?  @map("postal_code")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  appointments Appointment[]

  @@map("patients")
  @@index([pesel])
  @@index([city])
  @@index([email])
}

model Vaccine {
  id                Int      @id @default(autoincrement())
  name              String
  manufacturer      String
  batchNumber       String   @unique @map("batch_number")
  expiryDate        DateTime @map("expiry_date")
  dosesRequired     Int      @default(2) @map("doses_required")
  storageTemperature String? @map("storage_temperature")
  createdAt         DateTime @default(now()) @map("created_at")

  vaccinations      Vaccination[]

  @@map("vaccines")
  @@index([batchNumber])
  @@index([expiryDate])
}

model Appointment {
  id             String          @id @default(uuid())
  patientId      String          @map("patient_id")
  clinicId       Int             @map("clinic_id")
  doctorId       String?         @map("doctor_id")
  appointmentDate DateTime       @map("appointment_date")
  status         AppointmentStatus @default(SCHEDULED)
  doseNumber     Int             @map("dose_number")
  notes          String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  patient        Patient         @relation(fields: [patientId], references: [id])
  clinic         Clinic          @relation(fields: [clinicId], references: [id])
  doctor         Doctor?         @relation(fields: [doctorId], references: [id])
  vaccination    Vaccination?

  @@map("appointments")
  @@index([patientId])
  @@index([clinicId])
  @@index([appointmentDate])
  @@index([status])
}

model Vaccination {
  id            String    @id @default(uuid())
  appointmentId String    @unique @map("appointment_id")
  vaccineId     Int       @map("vaccine_id")
  doctorId      String    @map("doctor_id")
  administeredAt DateTime  @map("administered_at")
  nextDoseDate  DateTime? @map("next_dose_date")
  sideEffects   String?
  createdAt     DateTime  @default(now()) @map("created_at")

  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  vaccine       Vaccine     @relation(fields: [vaccineId], references: [id])
  doctor        Doctor      @relation(fields: [doctorId], references: [id])

  @@map("vaccinations")
  @@index([vaccineId])
  @@index([doctorId])
  @@index([administeredAt])
}
